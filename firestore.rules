/**
 * @file Firebase Security Rules for Firestore.
 *
 * @core_philosophy
 * This ruleset enforces a strict user-ownership model for user data and disables comments.
 *
 * @data_structure
 * - User data is stored under `/users/{userId}`.
 * - Comments are stored under `/confession_lesson_comments/{commentId}` but are disabled.
 *
 * @key_security_decisions
 * - Users can only read and write their own user documents.
 * - Comment creation, updating, and deletion are explicitly denied.
 *
 * @denormalization_for_authorization
 *  - N/A (Ownership is based on document ID and auth UID).
 *
 * @structural_segregation
 *  - N/A (No public/private segregation).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user documents.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own user document.
     * @allow (get, list, update, delete) - Authenticated user can only access their own user document.
     * @deny (create) - User cannot create a document with an ID that does not match their own ID.
     * @deny (get, list, update, delete) - User cannot access another user's document.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.auth.uid == userId;
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Prevents any operations on confession lesson comments
     * @path /confession_lesson_comments/{commentId}
     * @allow None
     * @deny Any operation
     * @principle Comments are disabled
     */
    match /confession_lesson_comments/{commentId} {
      allow get, list, create, update, delete: if false;
    }
  }
}