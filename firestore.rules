/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles
 * and allows public read-only access to confession lesson comments, with write
 * access restricted to authenticated users.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information.
 * - /confession_lesson_comments/{commentId}: Stores comments on confession lessons.
 *
 * Key Security Decisions:
 * - User profiles are private and only accessible to the owner.
 * - Users can only create, update, and delete their own profiles.
 * - Listing user documents is not allowed.
 * - Confession lesson comments are publicly readable but can only be created by
 *   authenticated users.
 *
 * Denormalization for Authorization:
 *  - The `confession_lesson_comments` collection requires the `userId` on each
 *    document to match the authenticated user's UID for create operations.
 *    This avoids needing to query the `/users/{userId}` collection to verify
 *    ownership on comment creation.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) User 'user_abc' can create their own profile.
     * @allow (get, update, delete) User 'user_abc' can get, update, and delete their own profile.
     * @deny (create, update, delete) User 'user_xyz' cannot create, update, or delete user 'user_abc' profile.
     * @deny (list) Listing users is not allowed.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Only the user can read their own profile.
      allow get: if isOwner(userId);
      // Only the user can create their own profile.  The userId in the path
      // must match the userId in the data.
      allow create: if isOwner(userId) && request.resource.data.email is string;
      // Only the user can update their own profile.
      allow update: if isExistingOwner(userId) && isOwner(userId);
      // Only the user can delete their own profile.
      allow delete: if isExistingOwner(userId) && isOwner(userId);
      // Listing users is not allowed.
      allow list: if false;
    }

    /**
     * @description Controls access to confession lesson comments.
     * @path /confession_lesson_comments/{commentId}
     * @allow (get, list) Anyone can read comments.
     * @allow (create) User 'user_abc' can create a comment with their own userId.
     * @deny (create) User 'user_abc' cannot create a comment with someone else's userId.
     * @deny (update, delete) Only the owner can update or delete the comment.
     * @principle Allows public reads with owner-only writes, enforcing ownership on create.
     */
    match /confession_lesson_comments/{commentId} {
      // Anyone can read comments.
      allow get, list: if true;

      // An authenticated user can create a comment if the userId matches their auth.uid.
      allow create: if isSignedIn()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.topicId is string
                    && request.resource.data.userName is string
                    && request.resource.data.text is string
                    && request.resource.data.createdAt is string
                    && request.resource.data.userPhotoURL is string;

      // Only the owner can update the comment.
      allow update: if isExistingOwner(resource.data.userId) && resource.data.userId == request.auth.uid;

      // Only the owner can delete the comment.
      allow delete: if isExistingOwner(resource.data.userId) && resource.data.userId == request.auth.uid;
    }
  }

  // Helper function to determine if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the requested user id matches the
  // authentication uid.
  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  // Helper function to determine if the requested user id matches the
  // authentication uid, and that a document exists.
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}